# Створіть власний сервер надсилання пошти SMTP

## преамбула

SMTP може безпосередньо купувати послуги у хмарних постачальників, наприклад:

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Алі хмарне надсилання електронної пошти](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Ви також можете створити свій власний поштовий сервер - необмежене надсилання, низька загальна вартість.

Нижче ми крок за кроком демонструємо, як створити власний поштовий сервер.

## Вибір сервера

Власний SMTP-сервер потребує загальнодоступної IP-адреси з відкритими портами 25, 456 і 587.

Зазвичай використовувані публічні хмари заблокували ці порти за замовчуванням, і їх можливо відкрити, видавши робоче замовлення, але врешті-решт це дуже клопітно.

Я рекомендую купувати на хості, який має відкриті ці порти та підтримує налаштування зворотних доменних імен.

Тут я рекомендую [Contabo](https://contabo.com) .

Contabo – це хостинг-провайдер, що базується в Мюнхені, Німеччина, заснований у 2003 році з дуже конкурентними цінами.

Якщо ви виберете євро як валюту покупки, ціна буде дешевшою (сервер з 8 ГБ пам’яті та 4 процесорами коштує приблизно 529 юанів на рік, а початкова плата за встановлення безкоштовна протягом одного року).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

При оформленні замовлення вказуйте `prefer AMD` , і сервер з процесором AMD матиме кращу продуктивність.

Далі я візьму VPS Contabo як приклад, щоб продемонструвати, як створити власний поштовий сервер.

## Конфігурація системи Ubuntu

Операційна система тут Ubuntu 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Якщо сервер на ssh відображає `Welcome to TinyCore 13!` (як показано на малюнку нижче), це означає, що систему ще не встановлено. Відключіть ssh і зачекайте кілька хвилин, щоб увійти знову.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

Коли з’явиться `Welcome to Ubuntu 22.04.1 LTS` , ініціалізацію завершено, і ви можете продовжити виконання наступних кроків.

### [Необов’язково] Ініціалізація середовища розробки

Цей крок необов'язковий.

Для зручності я розмістив установку та налаштування системи програмного забезпечення ubuntu на [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) .

Виконайте наступну команду, щоб встановити одним клацанням миші.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Китайські користувачі, будь ласка, використовуйте натомість наступну команду, і мова, часовий пояс тощо будуть встановлені автоматично.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo вмикає IPV6

Увімкніть IPV6, щоб SMTP також міг надсилати електронні листи з адресами IPV6.

редагувати `/etc/sysctl.conf`

Змініть або додайте наступні рядки

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

Дотримуйтеся [посібника contabo: додавання з’єднання IPv6 до вашого сервера](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

Відредагуйте `/etc/netplan/01-netcfg.yaml` , додайте кілька рядків, як показано на малюнку нижче (файл конфігурації Contabo VPS за замовчуванням уже містить ці рядки, просто розкоментуйте їх).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

Потім `netplan apply` , щоб змінена конфігурація набула чинності.

Після успішного налаштування ви можете використовувати `curl 6.ipw.cn` для перегляду IPv6-адреси вашої зовнішньої мережі.

## Клонуйте опції репозиторію конфігурації

```
git clone https://github.com/wactax/ops.soft.git
```

## Створіть безкоштовний сертифікат SSL для свого доменного імені

Для надсилання пошти потрібен сертифікат SSL для шифрування та підпису.

Ми використовуємо [acme.sh](https://github.com/acmesh-official/acme.sh) для створення сертифікатів.

acme.sh — це інструмент автоматизованого підпису сертифікатів з відкритим кодом,

Увійдіть у сховище конфігурацій ops.soft, запустіть `./ssl.sh` , і папка `conf` буде створена у **верхньому каталозі** .

Знайдіть свого DNS-провайдера в [acme.sh dnsapi](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) , відредагуйте `conf/conf.sh` .

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

Потім запустіть `./ssl.sh 123.com` , щоб створити сертифікати `123.com` і `*.123.com` для вашого доменного імені.

Перший запуск автоматично встановить [acme.sh](https://github.com/acmesh-official/acme.sh) і додасть заплановане завдання для автоматичного оновлення. Ви можете побачити `crontab -l` , є такий рядок наступним чином.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Шлях для згенерованого сертифіката виглядає як `/mnt/www/.acme.sh/123.com_ecc。`

Оновлення сертифіката викличе сценарій `conf/reload/123.com.sh` , відредагуйте цей сценарій, ви можете додати такі команди, як `nginx -s reload` , щоб оновити кеш сертифікатів пов’язаних програм.

## Створіть сервер SMTP за допомогою chasquid

[chasquid](https://github.com/albertito/chasquid) — це SMTP-сервер з відкритим кодом, написаний мовою Go.

Як заміна давнім програмам поштового сервера, таким як Postfix і Sendmail, chasquid є простішим і легшим у використанні, а також його легше для вторинної розробки.

Запустіть `./chasquid/init.sh 123.com` буде встановлено автоматично одним клацанням миші (замініть 123.com на доменне ім’я відправника).

## Налаштуйте підпис електронної пошти DKIM

DKIM використовується для надсилання підписів електронної пошти, щоб листи не розглядалися як спам.

Після успішного виконання команди вам буде запропоновано встановити запис DKIM (як показано нижче).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

Просто додайте запис TXT до свого DNS (як показано нижче).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Перегляньте статус служби та журнали

 `systemctl status chasquid` Перегляд статусу служби.

Стан нормальної роботи показаний на малюнку нижче

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` або `journalctl -xeu chasquid` може переглядати журнал помилок.

## Зворотне налаштування доменного імені

Зворотне доменне ім’я дозволяє розв’язати IP-адресу у відповідне доменне ім’я.

Налаштування зворотного доменного імені може запобігти визначенню електронних листів як спаму.

Коли пошту отримано, сервер-одержувач виконає зворотний аналіз імені домену на IP-адресі сервера-відправника, щоб підтвердити, чи має сервер-відправник дійсне ім’я зворотного домену.

Якщо сервер-відправник не має зворотного доменного імені або якщо зворотне доменне ім’я не збігається з IP-адресою сервера-відправника, сервер-одержувач може розпізнати електронний лист як спам або відхилити його.

Відвідайте [https://my.contabo.com/rdns](https://my.contabo.com/rdns) і налаштуйте, як показано нижче

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

Після встановлення зворотного доменного імені не забувайте налаштувати пряму передачу доменних імен ipv4 та ipv6 на сервер.

## Відредагуйте ім'я хоста chasquid.conf

Змініть `conf/chasquid/chasquid.conf` на значення зворотного доменного імені.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

Потім запустіть `systemctl restart chasquid` , щоб перезапустити службу.

## Резервне копіювання conf у репозиторій git

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

Наприклад, я роблю резервну копію папки conf у власний процес github наступним чином

Спочатку створіть приватний склад

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

Зайти в каталог conf і відправити на склад

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Додайте відправника

бігати

```
chasquid-util user-add i@wac.tax
```

Можна додати відправника

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Переконайтеся, що пароль встановлено правильно

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

Після додавання користувача `chasquid/domains/wac.tax/users` буде оновлено, не забудьте відправити його на склад.

## DNS додати запис SPF

SPF (Sender Policy Framework) — це технологія перевірки електронної пошти, яка використовується для запобігання шахрайству електронною поштою.

Він перевіряє особу відправника електронної пошти, перевіряючи, чи IP-адреса відправника збігається із записами DNS доменного імені, за яке він себе видає, запобігаючи надсиланню фальшивих електронних листів шахраями.

Додавання записів SPF може максимально запобігти визначенню електронних листів як спаму.

Якщо ваш сервер доменних імен не підтримує тип SPF, просто додайте запис типу TXT.

Наприклад, SPF `wac.tax` такий

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

SPF для `_spf.wac.tax`

`v=spf1 a:smtp.wac.tax ~all`

Зауважте, що тут у мене є `include:_spf.google.com` , тому що пізніше я налаштую `i@wac.tax` як адресу відправлення в поштовій скриньці Google.

## Конфігурація DNS DMARC

DMARC — це абревіатура (Domain-based Message Authentication, Reporting & Conformance).

Він використовується для фіксації відмов SPF (можливо, через помилки конфігурації або хтось інший видає себе за вас, щоб надіслати спам).

Додайте запис TXT `_dmarc` ,

Зміст наступний

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Значення кожного параметра наступне

### p (Політика)

Вказує, як обробляти електронні листи, які не пройшли перевірку SPF (Sender Policy Framework) або DKIM (DomainKeys Identified Mail). Параметр p може мати одне з трьох значень:

* none: жодних дій не виконується, лише результат перевірки повертається відправнику через механізм звітування електронною поштою.
* Карантин: помістіть лист, який не пройшов перевірку, до папки спаму, але не відхилятиме лист безпосередньо.
* відхилити: напряму відхиляти електронні листи, які не пройшли перевірку.

### fo (Параметри помилок)

Визначає обсяг інформації, яку повертає механізм звітування. Для нього можна встановити одне з таких значень:

* 0: звіт про результати перевірки для всіх повідомлень
* 1: повідомляти лише про повідомлення, які не пройшли перевірку
* d: повідомляти лише про помилки підтвердження доменного імені
* s: повідомляти лише про помилки перевірки SPF
* l: повідомляти лише про помилки перевірки DKIM

### rua & ruf

* rua (URI звітності для зведених звітів): адреса електронної пошти для отримання зведених звітів
* ruf (URI звітів для звітів Forensic): адреса електронної пошти для отримання детальних звітів

## Додайте записи MX для пересилання електронних листів до Google Mail

Оскільки я не міг знайти безкоштовну корпоративну поштову скриньку, яка підтримує універсальні адреси (Catch-All, може отримувати будь-які електронні листи, надіслані на це доменне ім’я, без обмежень щодо префіксів), я використав chasquid для пересилання всіх електронних листів до моєї поштової скриньки Gmail.

**Якщо у вас є власна платна корпоративна поштова скринька, не змінюйте MX і пропустіть цей крок.**

Редагувати `conf/chasquid/domains/wac.tax/aliases` , встановити поштову скриньку пересилання

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` позначає всі електронні листи, `i` – префікс адреси електронної пошти користувача, який відправляє повідомлення, створеного вище. Для пересилання пошти кожному користувачеві потрібно додати рядок.

Потім додайте запис MX (тут я вказую безпосередньо на адресу зворотного доменного імені, як показано в першому рядку на малюнку нижче).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

Після завершення налаштування ви можете використовувати інші електронні адреси для надсилання електронних листів на `i@wac.tax` і `any123@wac.tax` , щоб перевірити, чи можете ви отримувати електронні листи в Gmail.

Якщо ні, перевірте журнал chasquid ( `grep chasquid /var/log/syslog` ).

## Надішліть електронний лист на адресу i@wac.tax за допомогою Google Mail

Після того як Google Mail отримав лист, я, природно, сподівався відповісти `i@wac.tax` замість i.wac.tax@gmail.com.

Відвідайте сторінку [https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) і натисніть «Додати іншу електронну адресу».

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

Потім введіть код підтвердження, отриманий електронною поштою, на яку було надіслано.

Нарешті, його можна встановити як адресу відправника за замовчуванням (разом із можливістю відповіді з тією ж адресою).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

Таким чином, ми завершили встановлення поштового сервера SMTP і одночасно використовуємо Google Mail для надсилання та отримання електронних листів.

## Надішліть тестовий електронний лист, щоб перевірити, чи конфігурація виконана успішно

Введіть `ops/chasquid`

Запустіть `direnv allow` встановити залежності (direnv було встановлено в попередньому процесі ініціалізації одним ключем, а до оболонки додано хук)

потім біжи

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Значення параметрів полягає в наступному

* користувач: ім'я користувача SMTP
* pass: пароль SMTP
* кому: одержувач

Ви можете надіслати тестовий електронний лист.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Рекомендується використовувати Gmail для отримання тестових електронних листів, щоб перевірити, чи конфігурації виконані успішно.

### Стандартне шифрування TLS

Як показано на малюнку нижче, є маленький замок, який означає, що сертифікат SSL успішно ввімкнено.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

Потім натисніть «Показати оригінальний лист»

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

Як показано на малюнку нижче, оригінальна сторінка електронної пошти Gmail відображає DKIM, що означає, що налаштування DKIM виконано успішно.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Перевірте Отримано в заголовку оригінального електронного листа, і ви побачите, що адреса відправника – IPV6, що означає, що IPV6 також налаштовано успішно.
